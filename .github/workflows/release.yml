name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  # Step 0: Validate merge commit has semantic prefix (PR title)
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check merge commit for semantic prefix
        run: |
          # Get the latest commit message (the squashed merge commit = PR title)
          COMMIT_MSG=$(git log -1 --format="%s")

          echo "Checking commit message: $COMMIT_MSG"

          # Check if commit has a semantic prefix
          SEMANTIC_PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?:"

          if echo "$COMMIT_MSG" | grep -qE "$SEMANTIC_PATTERN"; then
            echo "âœ… Valid semantic commit prefix found"
          else
            echo "âŒ ERROR: Commit message does not have a semantic prefix!"
            echo ""
            echo "Your PR title must use conventional commit format:"
            echo "  feat: add new feature"
            echo "  fix: resolve bug"
            echo "  docs: update documentation"
            echo "  refactor: code refactoring"
            echo "  perf: performance improvement"
            echo "  test: add tests"
            echo "  chore: maintenance tasks"
            echo ""
            echo "Please update your PR title and re-merge."
            exit 1
          fi

  # Step 1: Build check
  build:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./src
        run: bun install

      - name: Build
        working-directory: ./src
        run: bun run build

  # Step 2: Semantic Release (only after successful build)
  release:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: bun install

      - name: Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          bun add -d semantic-release @semantic-release/git @semantic-release/exec
          output=$(bunx semantic-release 2>&1) || true
          echo "$output"
          if echo "$output" | grep -q "Published release"; then
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            version=$(echo "$output" | grep -oP "Published release \K[0-9]+\.[0-9]+\.[0-9]+")
            echo "new_release_version=$version" >> $GITHUB_OUTPUT
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
          fi

  # Step 3: Deploy to Vercel (only after new release is published)
  deploy:
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Vercel CLI
        run: bun add -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=$VERCEL_TOKEN

      - name: Build Production
        run: vercel build --prod --token=$VERCEL_TOKEN

      - name: Deploy Production
        run: vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

      - name: Summary
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.release.outputs.new_release_version }}" >> $GITHUB_STEP_SUMMARY
