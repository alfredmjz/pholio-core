# Database

Database schema and migrations for Pholio.

## Structure

```
database/
├── migrations/              # Source migration files (version controlled)
│   └── 001_create_users_table.sql
├── generated/              # Generated SQL files (ignored by git)
│   └── combined-migrations.sql
└── README.md              # This file
```

## Quick Start

```bash
# Generate combined migration file
cd src && npm run db:migrate

# Then apply in Supabase:
# 1. Open database/generated/combined-migrations.sql
# 2. Copy all content (Ctrl+A, Ctrl+C)
# 3. Go to Supabase Dashboard → SQL Editor → New query
# 4. Paste (Ctrl+V) and click "Run"
```

## Folders

### migrations/

**Purpose**: Source of truth for database schema

- Contains all migration SQL files
- Version controlled in git
- Named with numeric prefixes: `001_`, `002_`, etc.
- Executed in order

**Files:**

- `001_create_users_table.sql` - Initial user table, triggers, RLS policies

### generated/

**Purpose**: Auto-generated combined SQL

- Not tracked in git (in `.gitignore`)
- Generated by `npm run db:migrate`
- Contains all migrations combined into one file
- Ready to copy/paste into Supabase SQL Editor

**Files:**

- `combined-migrations.sql` - All migrations combined

## Creating New Migrations

1. Create new file in `migrations/`:

```bash
# Example: 002_add_projects_table.sql
```

2. Write your SQL migration:

```sql
-- Migration: 002_add_projects_table
-- Description: Creates the projects table
-- Created: 2025-01-09

CREATE TABLE IF NOT EXISTS public.projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own projects"
ON public.projects FOR SELECT
USING (auth.uid() = user_id);
```

3. Run migration script:

```bash
cd src && npm run db:migrate
```

4. Apply in Supabase SQL Editor

## Best Practices

✅ Use `IF NOT EXISTS` for idempotency
✅ Drop existing policies before recreating (`DROP POLICY IF EXISTS`)
✅ Enable RLS on all tables (`ALTER TABLE ... ENABLE ROW LEVEL SECURITY`)
✅ Add descriptive comments at the top of each migration
✅ Handle errors gracefully in trigger functions
✅ Grant appropriate permissions
✅ Use `SECURITY DEFINER` for triggers that need to bypass RLS

## Current Schema

### Tables

- **users** - User profiles (id, email, full_name, avatar_url, timestamps)

### Functions

- `handle_new_user()` - Auto-creates profile on signup
- `update_updated_at_column()` - Auto-updates timestamps

### Triggers

- `on_auth_user_created` - Fires on INSERT to auth.users
- `update_users_updated_at` - Fires on UPDATE to users

### RLS Policies

- Users can view own profile
- Users can insert own profile
- Service role can insert profiles (for triggers)
- Users can update own profile

## Troubleshooting

**"No migration files found"**

- Ensure `.sql` files exist in `database/migrations/`

**"Could not find the table 'public.users'"**

- Run migrations in Supabase SQL Editor

**"Permission denied for schema public"**

- Ensure you're logged into Supabase as project owner

**Generated file not found**

- Run `cd src && npm run db:migrate` first
- Check `database/generated/` folder was created

## Learn More

See main `README.md` for complete documentation.
